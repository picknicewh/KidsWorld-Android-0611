function testPlat(){var u=navigator.userAgent;return u.indexOf("Android")>-1||u.indexOf("Adr")>-1?0:u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?1:2}function generateHtml(arr){var tmpHtml="",counts=arr.list.length,createTime=new Date(arr.createTime);if(tmpHtml+='<div class="section-left">',tmpHtml+='<span class="time" id="time">'+createTime.getDate()+"</span>",tmpHtml+='<span class="time2">'+getMonthZ(createTime.getMonth())+"</span></div>",tmpHtml+='<div class="section-right"><div class="app-content content-top">',tmpHtml+='<div class="text">'+arr.text+"</div>",1==arr.dynamicType&&0!=arr.imgUrl.length){var imgHtml="",imgArr=arr.imgUrl,imgLen=imgArr.length;if(1==imgLen)imgHtml+='<li><img src="'+imgArr[0]+'" class="oneImg" data-preview-src="'+imgArr[0].replace(/\/s/,"")+'" data-preview-group="'+imgIndex+'"/></li>';else for(var j=0;j<imgLen;j++)imgHtml+='<li><img src="'+imgArr[j]+'" data-preview-src="'+imgArr[j].replace(/\/s/,"")+'" data-preview-group="'+imgIndex+'"/></li>';tmpHtml+='<ul class="image2">'+imgHtml+"</ul>",imgIndex++}return tmpHtml+='</div><div class="app-control" data-islike='+arr.isAgree+" data-likecnt="+counts,tmpHtml+=" data-dynamicid="+arr.dynamicId+">",tmpHtml+='<span class="app-time title-green" id="del">删除</span>',tmpHtml+=' <span class="mui-pull-right comment"><img src="../images/comment.jpg" style="width:16px;">',tmpHtml+=0!=arr.rewCount?'<span class="counts">'+arr.rewCount+"</span></span>":'<span class="counts">评论</span></span>',tmpHtml+='<span id="like" class="mui-pull-right like">',tmpHtml+=1==arr.isAgree?'<img src="../images/heart-filled.jpg" style="width:16px;">':'<img src="../images/heart.png" style="width:16px;">',tmpHtml+=0!=counts?'<span class="counts">'+counts+"</span></span></div>":'<span class="counts">赞</span></span></div>',tmpHtml+="</div>"}function pullupRefresh(){setTimeout(function(){mui("#pullrefresh").pullRefresh().endPullupToRefresh(!pageflag);var table=document.body.querySelector(".wrap-list"),data=(document.body.querySelectorAll(".app-mainBox"),{tsId:tsId,pageNumber:pageIndex,pageSize:pageSize});$.post(url+"/dynamics/myDynamic.do",data,function(response){if("0"==response.code)if(0==response.data.length)1==pageIndex&&mui.toast("暂无数据");else{var resultData=response.data;resultData.length!=pageSize&&(pageflag=!1);for(var i=0;i<resultData.length;i++){var li=document.createElement("div");li.className="app-mainBox",li.innerHTML=generateHtml(resultData[i]),table.appendChild(li)}}}),pageIndex++},1500)}function pulldownRefresh(){pageIndex=1,setTimeout(function(){var table=document.body.querySelector(".wrap-list"),data=(document.body.querySelectorAll(".app-mainBox"),{tsId:tsId,pageNumber:pageIndex,pageSize:pageSize});$.post(url+"/dynamics/myDynamic.do",data,function(response){if(0==response.code&&response.data.length>0){table.innerHTML="";var resultData=response.data,dataLen=resultData.length;dynamicId=resultData[0].dynamicId;for(var i=0;i<dataLen;i++){var li=document.createElement("div");li.className="app-mainBox",li.innerHTML=generateHtml(resultData[i]),table.appendChild(li)}}}),pageIndex=2,mui("#pullrefresh").pullRefresh().endPulldownToRefresh()},1500)}function backMessage(tsId,dynamicId){var data={tsId:tsId,dynamicId:dynamicId};$.post(url+"/dynamics/getDynamicDetail.do",data,function(response){if(0==response.code){var result=response.data,newIsLike=result.isAgree,newLikeCnt=result.list.length,newCommentCnt=result.dynamidRewList.length,nodeTree=(result.list,$("div.app-control[data-dynamicid = "+dynamicId+"]"));nodeTree.data("islike",newIsLike),nodeTree.data("likecnt",newLikeCnt),0==newLikeCnt?nodeTree.children(".like").children("span.counts").text("赞"):nodeTree.children(".like").children("span.counts").text(newLikeCnt),0==newCommentCnt?nodeTree.children(".comment").children("span.counts").text("评论"):nodeTree.children(".comment").children("span.counts").text(newCommentCnt),1==newIsLike?nodeTree.children("span#like").children("img").attr("src","../images/heart-filled.jpg"):nodeTree.children("span#like").children("img").attr("src","../images/heart.png")}})}function getQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(reg);return null!=r?encodeURIComponent(r[2]):null}var url="http://eduslb.openhunme.com/KidsWorld",imgIndex=2,pageflag=!0,pageIndex=1,tsId=getQueryString("tsId"),pageSize=15,platFlag=testPlat();mui.init({pullRefresh:{container:"#pullrefresh",up:{contentrefresh:"正在加载...",callback:pullupRefresh}}}),mui.previewImage();var count=0;$(".mui-scroll").on("tap","#del",function(event){var $this=$(this),dynamicId=$this.parent().data("dynamicid"),wrap=$this.parent().parent().parent(),btnArray=["取消","删除"];mui.confirm("","确定删除吗？",btnArray,function(e){if(1==e.index){var datas={tsId:tsId,dynamicId:dynamicId};$.post(url+"/dynamics/deleteDynamic.do",datas,function(response){if(0==response.code)if(wrap.remove(),0==platFlag)change_tob.noticeChange();else{if(1!=platFlag)return;refreshTrend()}})}})}),$(".mui-scroll").on("tap","span.comment",function(event){var $this=$(this),dynamicIds=$this.parent().data("dynamicid");if(0==platFlag)change_tb.startStatusDetils(dynamicIds);else{if(1!=platFlag)return;OCdynamicId.iosUsercomment(dynamicIds)}}),$(".mui-scroll").on("tap","#like",function(event){var $this=$(this),likecnt=$this.parent().data("likecnt"),islike=$this.parent().data("islike"),dynamicIds=$this.parent().data("dynamicid"),dataz={tsId:tsId,dynamicId:dynamicIds,cancel:1},dataq={tsId:tsId,dynamicId:dynamicIds,cancel:2};1==islike&&1==likecnt?$.post(url+"/dynamics/subPraise.do",dataq,function(response){0==response.code?($this.children("img").attr("src","../images/heart.png"),$this.children("span.counts").text("赞"),$this.parent().data("islike",2),$this.parent().data("likecnt",0)):mui.toast("取消赞失败")}):2==islike&&0==likecnt?$.post(url+"/dynamics/subPraise.do",dataz,function(response){0==response.code?($this.parent().data("islike",1),$this.parent().data("likecnt",1),$this.children("img").attr("src","../images/heart-filled.jpg"),$this.children("span.counts").text("1")):mui.toast("点赞失败")}):1==islike?$.post(url+"/dynamics/subPraise.do",dataq,function(response){0==response.code?($this.children("img").attr("src","../images/heart.png"),$this.children("span.counts").text(likecnt-1),$this.parent().data("islike",2),$this.parent().data("likecnt",likecnt-1)):mui.toast("取消赞失败")}):$.post(url+"/dynamics/subPraise.do",dataz,function(response){0==response.code?($this.parent().data("islike",1),$this.parent().data("likecnt",likecnt+1),$this.children("img").attr("src","../images/heart-filled.jpg"),$this.children("span.counts").text(likecnt+1)):mui.toast("点赞失败")})}),mui.os.plus?mui.plusReady(function(){setTimeout(function(){mui("#pullrefresh").pullRefresh().pullupLoading()},1e3)}):mui.ready(function(){mui("#pullrefresh").pullRefresh().pullupLoading()}),function(doc,win){var docEl=doc.documentElement||doc.body,resizeEvt="orientationchange"in window?"orientationchange":"resize",recalc=function(){var clientWidth=docEl.clientWidth;clientWidth&&(docEl.style.fontSize=20*(clientWidth/320)+"px",docEl.style.display="block")};docEl.style.display="none",doc.addEventListener&&(win.addEventListener(resizeEvt,recalc,!1),doc.addEventListener("DOMContentLoaded",recalc,!1))}(document,window);var getMonthZ=function(month){var monthStr="";switch(month+1){case 1:monthStr="一月";break;case 2:monthStr="二月";break;case 3:monthStr="三月";break;case 4:monthStr="四月";break;case 5:monthStr="五月";break;case 6:monthStr="六月";break;case 7:monthStr="七月";break;case 8:monthStr="八月";break;case 9:monthStr="九月";break;case 10:monthStr="十月";break;case 11:monthStr="十一月";break;case 12:monthStr="十二月"}return monthStr};