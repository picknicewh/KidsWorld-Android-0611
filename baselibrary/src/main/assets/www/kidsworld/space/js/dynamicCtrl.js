function testPlat(){var u=navigator.userAgent;return u.indexOf("Android")>-1||u.indexOf("Adr")>-1?0:u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?1:2}function backMessage(tsId,dynamicId){var data={tsId:tsId,dynamicId:dynamicId};$.post(url+"/dynamics/getDynamicDetail.do",data,function(response){if(0==response.code){var result=response.data,temp="",newIsLike=result.isAgree,newLikeCnt=result.list.length,newCommentCnt=result.dynamidRewList.length,newLikeName=result.list,nodeTree=$("div.app-control[data-dynamicid = "+dynamicId+"]");if(nodeTree.data("islike",newIsLike),nodeTree.data("likecnt",newLikeCnt),0==newLikeCnt?nodeTree.children(".like").children("span.counts").text("赞"):nodeTree.children(".like").children("span.counts").text(newLikeCnt),0==newCommentCnt?nodeTree.children(".comment").children("span.counts").text("评论"):nodeTree.children(".comment").children("span.counts").text(newCommentCnt),1==newIsLike?nodeTree.children("span#like").children("img").attr("src","../images/heart-filled.jpg"):nodeTree.children("span#like").children("img").attr("src","../images/heart.png"),newLikeCnt>0){for(var n=0,namesLen=newLikeName.length;n<namesLen;n++)temp+='<span class="name" value="'+newLikeName[n]+'">'+newLikeName[n]+"</span>";nodeTree.next("#names").children("#wrap")[0].innerHTML=temp}}})}function loadNew(){setTimeout(function(){var table=document.body.querySelector(".mui-table-view"),data=(document.body.querySelectorAll(".app-mainBox"),{tsId:tsId,groupId:groupId,groupType:groupType,pageNumber:1,pageSize:100,dynamicId:dynamicId,type:2});$.post(url+"/dynamics/getDynamic.do",data,function(response){if(0==platFlag)showDos.setStatus();else{if(1!=platFlag)return;tooc()}if(0==response.code&&response.data.length>0){var resultData=response.data;dynamicId=resultData[0].dynamicId;for(var i=resultData.length-1;i>-1;i--){var li=document.createElement("div");li.className="app-mainBox",li.innerHTML=generateHtml(resultData[i]),table.insertBefore(li,table.firstChild)}}}),mui("#pullrefresh").pullRefresh().endPulldownToRefresh()},1500)}function pulldownRefresh(){firstTime=(new Date).Format("yyyy-MM-dd hh:mm:ss"),pageIndex=1;var u=navigator.userAgent;u.indexOf("Android")>-1||u.indexOf("Adr")>-1?showDos.setStatus():u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&tooc(),setTimeout(function(){var table=document.body.querySelector(".mui-table-view"),data=(document.body.querySelectorAll(".app-mainBox"),{tsId:tsId,groupId:groupId,groupType:groupType,pageNumber:pageIndex,pageSize:pageSize,createTime:firstTime,type:1});$.post(url+"/dynamics/getDynamic.do",data,function(response){if(0==response.code&&response.data.length>0){table.innerHTML="";var resultData=response.data,dataLen=resultData.length;dynamicId=resultData[0].dynamicId;for(var i=0;i<dataLen;i++){var li=document.createElement("div");li.className="app-mainBox",li.innerHTML=generateHtml(resultData[i]),table.appendChild(li)}}}),pageIndex=2,mui("#pullrefresh").pullRefresh().endPulldownToRefresh()},1500)}function pullupRefresh(){setTimeout(function(){mui("#pullrefresh").pullRefresh().endPullupToRefresh(!pageflag);var table=document.body.querySelector(".mui-table-view"),data=(document.body.querySelectorAll(".app-mainBox"),{tsId:tsId,groupId:groupId,groupType:groupType,pageNumber:pageIndex,pageSize:pageSize,createTime:firstTime,type:1});$.post(url+"/dynamics/getDynamic.do",data,function(response){if("0"==response.code)if(0==response.data.length)1==pageIndex&&mui.toast("暂无数据");else{var resultData=response.data,dataLen=resultData.length;dynamicId=resultData[0].dynamicId,dataLen!=pageSize&&(pageflag=!1);for(var i=0;i<dataLen;i++){var li=document.createElement("div");li.className="app-mainBox",li.innerHTML=generateHtml(resultData[i]),table.appendChild(li)}}}),pageIndex++},1500)}function generateHtml(arr){var tmpHtml="",names=[],counts=arr.list.length;if(tmpHtml+='<div class="app-leftIn"><div class="app-photo">',tmpHtml+=1==arr.tsType?"<img src="+arr.img+'><span class="mui-badge mui-badge-danger app-badge">学</span>':"<img src="+arr.img+'><span class="mui-badge mui-badge-danger app-badge back-green">师</span>',tmpHtml+='</div></div><div class="app-rigthIn"><div class="app-name">'+arr.tsName+'</div><div class="app-content">',tmpHtml+='<div class="text">'+arr.text+"</div>",1==arr.dynamicType&&0!=arr.imgUrl.length){var imgHtml="",imgArr=arr.imgUrl,imgLen=imgArr.length;if(1==imgLen)imgHtml+='<li><img src="'+imgArr[0]+'" class="oneImg" data-preview-src="'+imgArr[0].replace(/\/s/,"")+'" data-preview-group="'+imgIndex+'"/></li>';else for(var j=0;j<imgLen;j++)imgHtml+='<li><img src="'+imgArr[j]+'" data-preview-src="'+imgArr[j].replace(/\/s/,"")+'" data-preview-group="'+imgIndex+'"/></li>';tmpHtml+='<ul class="image2">'+imgHtml+"</ul>",imgIndex++}if(tmpHtml+="</div>",tmpHtml+='<div class="app-control" data-islike='+arr.isAgree+" data-likecnt="+counts,tmpHtml+=" data-dynamicid="+arr.dynamicId+'><span class="app-time">',tmpHtml+='<span class="app-time">'+arr.date+"</span></span>",tmpHtml+=' <span class="mui-pull-right comment"><img src="../images/comment.jpg" style="width:16px;">',tmpHtml+=0!=arr.rewCount?'<span class="counts">'+arr.rewCount+"</span></span>":'<span class="counts">评论</span></span>',tmpHtml+='<span id="like" class="mui-pull-right like">',tmpHtml+=1==arr.isAgree?'<img src="../images/heart-filled.jpg" style="width:16px;">':'<img src="../images/heart.png" style="width:16px;">',tmpHtml+=0!=counts?'<span class="counts">'+counts+"</span></span></div>":'<span class="counts">赞</span></span></div>',0!=arr.list.length){names=arr.list,tmpHtml+='<div class="names" id="names"><span class="top"></span><img src="../images/lightHeart.png" width="14px">',tmpHtml+='<div id="wrap" style="display:inline-block">';for(var n=0,namesLen=names.length;n<namesLen;n++)tmpHtml+='<span class="name" value='+names[n]+">"+names[n]+"</span>"}else tmpHtml+='<div class="names" id="names" hidden><span class="top"></span><img src="../images/lightHeart.png" width="14px"><div id="wrap" style="display:inline-block">';return tmpHtml+="</div></div></div></div>"}function getQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i"),r=window.location.search.substr(1).match(reg);return null!=r?decodeURIComponent(r[2]):null}function ISODateString(d){function pad(n){return n<10?"0"+n:n}return d.getUTCFullYear()+"-"+pad(d.getUTCMonth()+1)+"-"+pad(d.getUTCDate())+"T"+pad(d.getUTCHours())+":"+pad(d.getUTCMinutes())+":"+pad(d.getUTCSeconds())+"Z"}var url="http://eduslb.openhunme.com/KidsWorld",imgIndex=2,pageIndex=1,pageSize=15,tsId=getQueryString("tsId"),groupId=getQueryString("groupId"),groupType=getQueryString("groupType"),firstTime=getQueryString("clickTime"),dynamicId=null,myName=getQueryString("myName"),platFlag=testPlat();$(".mui-scroll").on("tap","span.comment",function(event){var $this=$(this),dynamicIds=$this.parent().data("dynamicid");if(0==platFlag)showDos.startStatusDetils(dynamicIds);else{if(1!=platFlag)return;OCdynamicId.iosUsercomment(dynamicIds)}}),$(".mui-scroll").on("tap","#like",function(event){var $this=$(this),likecnt=$this.parent().data("likecnt"),islike=$this.parent().data("islike"),dynamicIds=$this.parent().data("dynamicid"),dataz={tsId:tsId,dynamicId:dynamicIds,cancel:1},dataq={tsId:tsId,dynamicId:dynamicIds,cancel:2};1==islike&&1==likecnt?$.post(url+"/dynamics/subPraise.do",dataq,function(response){0==response.code?($this.parent().siblings("div#names").children("#wrap").children("span[value="+myName+"]").remove(),$this.parent().siblings("div#names").hide(),$this.children("img").attr("src","../images/heart.png"),$this.children("span.counts").text("赞"),$this.parent().data("islike",2),$this.parent().data("likecnt",0)):mui.toast("取消赞失败")}):2==islike&&0==likecnt?$.post(url+"/dynamics/subPraise.do",dataz,function(response){0==response.code?($this.parent().data("islike",1),$this.parent().data("likecnt",1),$this.children("img").attr("src","../images/heart-filled.jpg"),$this.children("span.counts").text("1"),$this.parent().siblings("div#names").children("#wrap").append('<span class="name" value='+myName+">"+myName+"</span>"),$this.parent().siblings("div#names").show()):mui.toast("点赞失败")}):1==islike?$.post(url+"/dynamics/subPraise.do",dataq,function(response){0==response.code?($this.parent().siblings("div#names").children("#wrap").children("span[value="+myName+"]").remove(),$this.children("img").attr("src","../images/heart.png"),$this.children("span.counts").text(likecnt-1),$this.parent().data("islike",2),$this.parent().data("likecnt",likecnt-1)):mui.toast("取消赞失败")}):$.post(url+"/dynamics/subPraise.do",dataz,function(response){0==response.code?($this.parent().data("islike",1),$this.parent().data("likecnt",likecnt+1),$this.children("img").attr("src","../images/heart-filled.jpg"),$this.children("span.counts").text(likecnt+1),$this.parent().siblings("div#names").children("#wrap").append('<span class="name" value='+myName+">"+myName+"</span>")):mui.toast("点赞成功")})}),mui.previewImage();var pageflag=!0;mui.init({pullRefresh:{container:"#pullrefresh",down:{callback:pulldownRefresh},up:{contentrefresh:"正在加载...",callback:pullupRefresh}}}),Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt},function(doc,win){var docEl=doc.documentElement||doc.body,resizeEvt="orientationchange"in window?"orientationchange":"resize",recalc=function(){var clientWidth=docEl.clientWidth;clientWidth&&(docEl.style.fontSize=20*(clientWidth/320)+"px",docEl.style.display="block")};docEl.style.display="none",doc.addEventListener&&(win.addEventListener(resizeEvt,recalc,!1),doc.addEventListener("DOMContentLoaded",recalc,!1))}(document,window),mui.os.plus?mui.plusReady(function(){setTimeout(function(){mui("#pullrefresh").pullRefresh().pullupLoading()},1e3)}):mui.ready(function(){mui("#pullrefresh").pullRefresh().pullupLoading()});